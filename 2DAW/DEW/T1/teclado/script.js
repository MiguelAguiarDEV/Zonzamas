const teclas = {
    
    0 : [{
            "nombre": "Âº",
            "normal": "Âº",
            "shift": "Âª",
            "altgr": "\\"
        },
        {
            "nombre": "1",
            "normal": "1",
            "shift": "!",
            "altgr": "|"
        },
        {
            "nombre": "2",
            "normal": "2",
            "shift": '"',
            "altgr": "@"
        },
        {
            "nombre": "3",
            "normal": "3",
            "shift": "Â·",
            "altgr": "#"
        },
        {
            "nombre": "4",
            "normal": "4",
            "shift": "$",
            "altgr": null
        },
        {
            "nombre": "5",
            "normal": "5",
            "shift": "%",
            "altgr": null
        },
        {
            "nombre": "6",
            "normal": "6",
            "shift": "&",
            "altgr": "Â¬"
        },
        {
            "nombre": "7",
            "normal": "7",
            "shift": "/",
            "altgr": null
        },
        {
            "nombre": "8",
            "normal": "8",
            "shift": "(",
            "altgr": "{"
        },
        {
            "nombre": "9",
            "normal": "9",
            "shift": ")",
            "altgr": "}"
        },
        {
            "nombre": "0",
            "normal": "0",
            "shift": "=",
            "altgr": null
        },
        {
            "nombre": "'",
            "normal": "'",
            "shift": "?",
            "altgr": null
        },
        {
            "nombre": "Â¡",
            "normal": "Â¡",
            "shift": "Â¿",
            "altgr": null
        },
        {
            "nombre": "Backspace",
            "normal": "Retroceso",
            "shift": "Retroceso",
            "altgr": "Retroceso"
        }],
    1 : [{
            "nombre": "Tab",
            "normal": "Tab",
            "shift": "Tab",
            "altgr": "Tab"
        },
        {
            "nombre": "Q",
            "normal": "q",
            "shift": "Q",
            "altgr": null
        },
        {
            "nombre": "W",
            "normal": "w",
            "shift": "W",
            "altgr": null
        },
        {
            "nombre": "E",
            "normal": "e",
            "shift": "E",
            "altgr": "â‚¬"
        },
        {
            "nombre": "R",
            "normal": "r",
            "shift": "R",
            "altgr": null
        },
        {
            "nombre": "T",
            "normal": "t",
            "shift": "T",
            "altgr": null
        },
        {
            "nombre": "Y",
            "normal": "y",
            "shift": "Y",
            "altgr": null
        },
        {
            "nombre": "U",
            "normal": "u",
            "shift": "U",
            "altgr": null
        },
        {
            "nombre": "I",
            "normal": "i",
            "shift": "I",
            "altgr": null
        },
        {
            "nombre": "O",
            "normal": "o",
            "shift": "O",
            "altgr": null
        },
        {
            "nombre": "P",
            "normal": "p",
            "shift": "P",
            "altgr": null
        },
        {
            "nombre": "`",
            "normal": "`",
            "shift": "^",
            "altgr": "["
        },
        {
            "nombre": "+",
            "normal": "+",
            "shift": "*",
            "altgr": "]"
        },
        {
            "nombre": "Enter",
            "normal": "Enter",
            "shift": "Enter",
            "altgr": "Enter"
        }],
    2 : [{
            "nombre": "CapsLock",
            "normal": "BloqMayÃºs",
            "shift": "BloqMayÃºs",
            "altgr": "BloqMayÃºs"
        },
        {
            "nombre": "A",
            "normal": "a",
            "shift": "A",
            "altgr": null
        },
        {
            "nombre": "S",
            "normal": "s",
            "shift": "S",
            "altgr": null
        },
        {
            "nombre": "D",
            "normal": "d",
            "shift": "D",
            "altgr": null
        },
        {
            "nombre": "F",
            "normal": "f",
            "shift": "F",
            "altgr": null
        },
        {
            "nombre": "G",
            "normal": "g",
            "shift": "G",
            "altgr": null
        },
        {
            "nombre": "H",
            "normal": "h",
            "shift": "H",
            "altgr": null
        },
        {
            "nombre": "J",
            "normal": "j",
            "shift": "J",
            "altgr": null
        },
        {
            "nombre": "K",
            "normal": "k",
            "shift": "K",
            "altgr": null
        },
        {
            "nombre": "L",
            "normal": "l",
            "shift": "L",
            "altgr": null
        },
        {
            "nombre": "Ã±",
            "normal": "Ã±",
            "shift": "Ã‘",
            "altgr": null
        },
        {
            "nombre": "Â´",
            "normal": "Â´",
            "shift": "Â¨",
            "altgr": "{"
        },
        {
            "nombre": "Ã§",
            "normal": "Ã§",
            "shift": "Ã‡",
            "altgr": "}"
        },
    ],
    3 : [{
            "nombre": "Shift",
            "normal": "Shift",
            "shift": "Shift",
            "altgr": "Shift"
        },
        {
            "nombre": "<",
            "normal": "<",
            "shift": ">",
            "altgr": null
        },
        {
            "nombre": "Z",
            "normal": "z",
            "shift": "Z",
            "altgr": null
        },
        {
            "nombre": "X",
            "normal": "x",
            "shift": "X",
            "altgr": null
        },
        {
            "nombre": "C",
            "normal": "c",
            "shift": "C",
            "altgr": null
        },
        {
            "nombre": "V",
            "normal": "v",
            "shift": "V",
            "altgr": null
        },
        {
            "nombre": "B",
            "normal": "b",
            "shift": "B",
            "altgr": null
        },
        {
            "nombre": "N",
            "normal": "n",
            "shift": "N",
            "altgr": null
        },
        {
            "nombre": "M",
            "normal": "m",
            "shift": "M",
            "altgr": null
        },
        {
            "nombre": ",",
            "normal": ",",
            "shift": ";",
            "altgr": null
        },
        {
            "nombre": ".",
            "normal": ".",
            "shift": ":",
            "altgr": null
        },
        {
            "nombre": "-",
            "normal": "-",
            "shift": "_",
            "altgr": null
        },
        {
            "nombre": "Shift",
            "normal": "Shift",
            "shift": "Shift",
            "altgr": "Shift"
        }
    ],
    4 : [
        {
            "nombre": "",
            "normal": "Espacio",
            "shift": "Espacio",
            "altgr": "Espacio"
        },
        {
            "nombre": "AltGraph",
            "normal": "AltGr",
            "shift": "AltGr",
            "altgr": "AltGr"
        },
        {
            "nombre": "ArrowLeft",
            "normal": "ðŸ ”",
            "shift": "ðŸ ”",
            "altgr": "ðŸ ”"
        },
        {
            "nombre": "ArrowRight",
            "normal": "ðŸ –",
            "shift": "ðŸ –",
            "altgr": "ðŸ –"
        }
    ]
};


const teclasValidas = [...new Set(Object.values(teclas).map((nivelTeclas) => {
    return nivelTeclas.map((tecla) => [tecla.nombre, tecla.shift, tecla.altgr].filter(Boolean));
}).flat(2))];

console.log(teclasValidas);

const cursor = (document.getElementById("cursor")).outerHTML;
const tecladoHTML = document.getElementById("teclado");
const texto = document.getElementById("texto");
var tipoTeclado = 'normal';
var posicionCursor = 0;
var bloqMayusActivo = false;
function crearTecladoHTML (evento){
    tecladoHTML.innerHTML = "";
    if (evento === 'normal' || evento === 'shift' || evento === 'altgr') {
        Object.keys(teclas).forEach((tecla,i) => {
            const fila = document.createElement("div");
            fila.classList = ("fila fila" + i);

            teclas[i].forEach((tecla) => {
                let teclaHTML = document.createElement("div");
                teclaHTML.innerHTML = tecla[evento];
                teclaHTML.className = "tecla "+tecla["normal"];
                fila.appendChild(teclaHTML);
            });

            tecladoHTML.appendChild(fila);
        });

    } else {
        console.log('eventoumento no vÃ¡lido: ' + evento);
    
    }
}
crearTecladoHTML(tipoTeclado);
texto.removeChild(document.getElementById("cursor"));
texto.innerHTML = cursor;



function modificarTexto(tecla){
    texto.innerHTML = texto.innerHTML.replace(cursor,"");
        let texto1
        let texto2
        console.log("posicion: ",posicionCursor)
        if(texto.innerHTML.length > 0){
            texto1 = texto.innerHTML.slice(0,posicionCursor);
            texto2 = texto.innerHTML.slice(posicionCursor);
        }else{
            texto1 = '';
            texto2 = '';
        }

        switch (tecla) {
        case 'Shift':
            tipoTeclado = 'shift';
            console.log("Se cambio a shift")
            break;
        case 'AltGraph':
        case 'AltGr':
            tipoTeclado = 'altgr';
            break;  
        case 'CapsLock':
        case 'BloqMayÃºs':
            if (bloqMayusActivo) {
                tipoTeclado = 'normal';
                bloqMayusActivo = false;
            } else {
                tipoTeclado = 'shift';
                bloqMayusActivo = true;

            }
            console.log(bloqMayusActivo)
            break;
        case 'ArrowLeft':
        case 'ðŸ ”':
            posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 1;
            console.log(posicionCursor)
            if(texto.innerHTML.length > 0){
                texto1 = texto.innerHTML.slice(0,posicionCursor);
                texto2 = texto.innerHTML.slice(posicionCursor);
            }else{
                texto1 = '';
                texto2 = '';
            }
            break;
        case 'ArrowRight':
        case 'ðŸ –':
            console.log(texto.innerHTML.length)
            posicionCursor = posicionCursor >= texto.innerHTML.length ? posicionCursor : posicionCursor +1;
            if(texto.innerHTML.length > 0){
                texto1 = texto.innerHTML.slice(0,posicionCursor);
                texto2 = texto.innerHTML.slice(posicionCursor);
            }else{
                texto1 = '';
                texto2 = '';
            }
            break;
        case 'Backspace':
        case 'Retroceso':
            if (/^&.{4};$/.test(texto1.slice(-6,))){
                texto1 = texto1.slice(0,-6);
                posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 5;

            } else if (/^&.{3};$/.test(texto1.slice(-5,))){
                texto1 = texto1.slice(0,-5);
                posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 4;
            } else if (/^&.{2};$/.test(texto1.slice(-4,))){
                texto1 = texto1.slice(0,-5);
                posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 3;
            } else if(texto1.slice(-4,) == "<br>"){
                texto1 = texto1.slice(0,-4);
                posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 1;

            }
            else{
                texto1 = texto1.slice(0, -1);
                posicionCursor = posicionCursor <= 0 ? 0 : posicionCursor - 1;
            }
            texto.innerHTML = texto1+cursor+texto2;
            break;
        case '&':
            texto1 += "&amp;";
            posicionCursor +=5;
            break
        case '<':
        case '>':
            if(tecla == '<'){
                texto1 += "&lt;";
            }else{
                texto1 += "&gt;";
            }
            posicionCursor +=4;
            break
        case 'Enter':
            texto1 += "<br>";
            posicionCursor = texto1.length;
            break;
        case ' ': 
        case 'Espacio':
            texto1 += "&nbsp;";
            posicionCursor = texto1.length;
            break
        case 'Tab':
            texto1 += "&nbsp;".repeat(4) ;
            posicionCursor = texto1.length;
            break
        default:
            texto1 += tecla;
            posicionCursor = texto1.length;
            if (bloqMayusActivo) {
                tipoTeclado = 'shift';
            }else{
                tipoTeclado = 'normal';
            }
            break;
    }
    texto.innerHTML = texto1+cursor+texto2;
    crearTecladoHTML(tipoTeclado);
}






tecladoHTML.addEventListener('click', (event) => {
    if(event.target.classList[0] === 'tecla'){
        modificarTexto(event.target.innerHTML);
    }
});


document.addEventListener('keydown', function(event) {
    if(teclasValidas.includes(event.key) || teclasValidas.includes(event.key.toUpperCase())){
        console.log(event.key);
        modificarTexto(event.key);
    }
    event.preventDefault();
});


